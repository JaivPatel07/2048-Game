<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2048 Game</title>
    <link rel="stylesheet" href="index.css">
</head>

<body>

    <h1>2048 Game</h1>
    <div class="score">Score: <span id="score">0</span></div>
    <button onclick="startGame()">Restart</button>

    <div id="game"></div>

    <script>
        const gridSize = 4;
        let grid = [];
        let score = 0;
        function startGame(){
            score = 0;
            document.getElementById("score").textContent = score;
            grid = Array.from({length:gridSize}, ()=>Array(gridSize).fill(0));
            addRandomTile();
            addRandomTile();

            render();
        }
        function addRandomTile(){
            let emptyCells = [];

            for(let r=0;r<gridSize;r++){
                for(let c=0;c<gridSize;c++){
                    if(grid[r][c] === 0){
                        emptyCells.push([r,c]);
                    }
                }
            }
            if(emptyCells.length === 0) {
                return;
            }
            let pick = emptyCells[Math.floor(Math.random()*emptyCells.length)];
            let r = pick[0];
            let c = pick[1];

            grid[r][c] = Math.random()<0.9 ? 2 : 4; // 90% chance of 2, 10% chance of 4
        }

        // draw board on screen
        function render(){
            const boardDiv = document.getElementById("game");
            boardDiv.innerHTML = "";

            grid.flat().forEach(num=>{
                const cell = document.createElement("div");
                cell.className = "tile";
                cell.textContent = num === 0 ? "" : num;
                cell.style.background = getTileColor(num);
                boardDiv.appendChild(cell);
            });
        }
        function getTileColor(n){
            const colors={
                0:"#cdc1b4",2:"#eee4da",4:"#ede0c8",8:"#f2b179",16:"#f59563",32:"#f67c5f",64:"#f65e3b",128:"#edcf72",256:"#edcc61",512:"#edc850",1024:"#edc53f",2048:"#edc22e"
            };
            return colors[n] || "#3c3a32";
        }
        
        function slideRow(row){
            row = row.filter(x=>x!==0);
            for(let i=0;i<row.length-1;i++){
                if(row[i] === row[i+1]){
                    row[i] *= 2;
                    score += row[i];
                    document.getElementById("score").textContent = score;
                    row[i+1] = 0;
                }
            }
            row = row.filter(x=>x!==0);
            while(row.length<gridSize){
                row.push(0);
            }
            return row;
        }
        function rotateBoard(b){
            let newGrid=[];
            for(let col=0;col<gridSize;col++){
                let newRow=[];
                for(let row=gridSize-1;row>=0;row--){
                    newRow.push(b[row][col]);
                }
                newGrid.push(newRow);
            }
            return newGrid;
        }

        function moveLeft(){
            let before = JSON.stringify(grid); // store state before move
            grid = grid.map(r=>slideRow(r));
            return before !== JSON.stringify(grid); // return true if moved
        }

        function handleMove(key){
            let moved = false;

            if(key==="ArrowLeft"){
                moved = moveLeft();
            }
            if(key==="ArrowRight"){
                grid = grid.map(r=>r.reverse());
                moved = moveLeft();
                grid = grid.map(r=>r.reverse());
            }
            if(key==="ArrowDown"){
                grid = rotateBoard(grid);
                moved = moveLeft();
                grid = rotateBoard(rotateBoard(rotateBoard(grid)));
            }
            if(key==="ArrowUp"){
                grid = rotateBoard(rotateBoard(rotateBoard(grid)));
                moved = moveLeft();
                grid = rotateBoard(grid);
            }
            if(moved){
                addRandomTile();
                render();
                checkGameOver();
            }
        }
        function checkGameOver(){
            for(let r=0;r<gridSize;r++){
                for(let c=0;c<gridSize;c++){
                    if(grid[r][c]===0) 
                        return;
                    if(c<3 && grid[r][c]===grid[r][c+1]) 
                        return;
                    if(r<3 && grid[r][c]===grid[r+1][c]) 
                        return;
                }
            }
            alert("Game Over!");
        }

        window.addEventListener("keydown",e=>{
            if(["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].includes(e.key)){
                e.preventDefault();
                handleMove(e.key);
            }
        });

        // for mobile touch controls
        let sx=0, sy=0;

        window.addEventListener("touchstart",e=>{
            sx = e.touches[0].clientX;
            sy = e.touches[0].clientY;
        });

        window.addEventListener("touchend",e=>{
            let dx = e.changedTouches[0].clientX - sx;
            let dy = e.changedTouches[0].clientY - sy;

            if(Math.abs(dx) > Math.abs(dy)){
                if(dx>30) handleMove("ArrowRight");
                if(dx<-30) handleMove("ArrowLeft");
            }else{
                if(dy>30) handleMove("ArrowDown");
                if(dy<-30) handleMove("ArrowUp");
            }
        });

        startGame();
    </script>

</body>
</html>